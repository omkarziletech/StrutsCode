/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.gp.cong.logisoft.struts.action;

import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.gp.cong.logisoft.beans.SearchRelayBean;

import com.gp.cong.logisoft.domain.Ports;
import com.gp.cong.logisoft.domain.ProcessInfo;
import com.gp.cong.logisoft.domain.RelayInquiry;
import com.gp.cong.logisoft.domain.User;
import com.gp.cong.logisoft.hibernate.dao.PortsDAO;
import com.gp.cong.logisoft.hibernate.dao.ProcessInfoDAO;
import com.gp.cong.logisoft.hibernate.dao.RelayInquiryDAO;
import com.gp.cong.logisoft.hibernate.dao.UserDAO;
import com.gp.cong.logisoft.struts.form.SearchRelayForm;

/** 
 * MyEclipse Struts
 * Creation date: 12-13-2007
 * 
 * XDoclet definition:
 * @struts.action path="/searchRelay" name="searchRelayForm" input="/jsps/datareference/searchRelay.jsp" scope="request" validate="true"
 */
public class SearchRelayAction extends Action {
    /*
     * Generated Methods
     */

    /**
     * Method execute
     * @param mapping
     * @param form
     * @param request
     * @param response
     * @return ActionForward
     */
    public ActionForward execute(ActionMapping mapping, ActionForm form,
            HttpServletRequest request, HttpServletResponse response) throws Exception {
        SearchRelayForm searchRelayForm = (SearchRelayForm) form;// TODO Auto-generated method stub
        HttpSession session = ((HttpServletRequest) request).getSession();
        String pol = searchRelayForm.getPol();
        String polText = searchRelayForm.getPolText();
        String pod = searchRelayForm.getPod();
        String podText = searchRelayForm.getPodText();
        String match = searchRelayForm.getMatch();
        String buttonValue = searchRelayForm.getButtonValue();
        String forwardName = "";
        String msg = "";
        String message = "";
        String loginname = "";

        SearchRelayBean srBean = new SearchRelayBean();
        srBean.setMatch(match);
        RelayInquiry relay = null;
        Ports portobj1 = null;
        Ports portobj2 = null;
        PortsDAO portsDAO = new PortsDAO();

        if (request.getParameter("paramid") != null) {

            RelayInquiryDAO relayInquiryDAO = new RelayInquiryDAO();

            RelayInquiry searchrelay = relayInquiryDAO.findById(Integer.parseInt(request.getParameter("paramid")));

            User userid = null;
            UserDAO user1 = new UserDAO();
            if (session.getAttribute("loginuser") != null) {
                userid = (User) session.getAttribute("loginuser");
            }
            ProcessInfoDAO processinfoDAO = new ProcessInfoDAO();
            ProcessInfo pi = new ProcessInfo();
            String programid = null;
            programid = (String) session.getAttribute("processinfoforrelay");

            String recordid = searchrelay.getRelayId().toString();
            String editstatus = "startedited";
            String deletestatus = "startdeleted";
            ProcessInfo processinfoobj = processinfoDAO.findById(Integer.parseInt(programid), recordid, deletestatus, editstatus);
            if (processinfoobj != null && processinfoobj.getUserid() != null && userid != null && userid.getUserId() != null && processinfoobj.getUserid().equals(userid.getUserId())) {
            } else {
                if (processinfoobj != null) {
                    String view = "3";
                    User loginuser = user1.findById(processinfoobj.getUserid());
                    loginname = loginuser.getLoginName();
                    msg = "This record is being used by ";
                    message = msg + loginname;
                    request.setAttribute("message", message);
                    session.setAttribute("view", view);
                    forwardName = "editRelay";

                } else {
                    pi.setUserid(userid.getUserId());
                    pi.setProgramid(Integer.parseInt(programid));
                    java.util.Date currdate = new java.util.Date();
                    pi.setProcessinfodate(currdate);
                    pi.setEditstatus(editstatus);
                    pi.setRecordid(recordid);
                    processinfoDAO.save(pi);
                    if (session.getAttribute("view") != null) {
                        session.removeAttribute("view");
                    }
                }
            }
            session.setAttribute("relay", searchrelay);

            forwardName = "editRelay";
            if (session.getAttribute("portobj1") != null) {
                session.removeAttribute("portobj1");
            }
            if (session.getAttribute("portobj2") != null) {
                session.removeAttribute("portobj2");
            }
            if (session.getAttribute("relayOrigin") != null) {
                session.removeAttribute("relayOrigin");
            }
            if (session.getAttribute("relayDestination") != null) {
                session.removeAttribute("relayDestination");
            }
        } else if (request.getParameter("param") != null) {

            RelayInquiryDAO relay1 = new RelayInquiryDAO();
            RelayInquiry relayInquiry = relay1.findById(Integer.parseInt(request.getParameter("param")));

            String view = "3";
            session.setAttribute("view", view);
            session.setAttribute("relay", relayInquiry);
            forwardName = "editRelay";
        } else {
            if (buttonValue != null && buttonValue.equals("search")) {
                if (session.getAttribute("relaycode") != null) {
                    session.removeAttribute("relaycode");
                }
                request.setAttribute("srBean", srBean);
                RelayInquiryDAO relayDAO = new RelayInquiryDAO();
                if (match.equals("match")) {
                    List relayList = relayDAO.findForSearchRelayAction(polText, podText);
                    session.setAttribute("relayList", relayList);
                    //session.setAttribute("RelayCaption","Realy {Match Only}");

                    if (polText != null && !polText.equals("")) {
                        session.setAttribute("RelayCaption", "POL {Match Only}");
                    }
                    if (podText != null && !podText.equals("")) {
                        session.setAttribute("RelayCaption", "POD {Match Only}");
                    }
                    if (!polText.equals("") && !podText.equals("")) {
                        session.setAttribute("RelayCaption", "POL-POD {Match Only}");
                    }
                } else if (match.equals("starts")) {
                    List relayList = relayDAO.findForSearchRelayStartAction(polText, podText, match);
                    session.setAttribute("relayList", relayList);
                    //session.setAttribute("RelayCaption","Relay {Start At List}");

                    if (polText != null && !polText.equals("")) {
                        session.setAttribute("RelayCaption", "POL {Start At List}");
                    }
                    if (podText != null && !podText.equals("")) {
                        session.setAttribute("RelayCaption", "POD {Start At List}");
                    }
                    if (!polText.equals("") && !podText.equals("")) {
                        session.setAttribute("RelayCaption", "POL-POD {Start At List}");
                    }



                }
                forwardName = "searchRelay";

            }
            if (buttonValue != null && buttonValue.equals("searchall")) {

                forwardName = "searchRelay";
                if (session.getAttribute("portobj1") != null) {
                    session.removeAttribute("portobj1");
                }
                if (session.getAttribute("portobj2") != null) {
                    session.removeAttribute("portobj2");
                }
                if (session.getAttribute("searchrelaycode") != null) {
                    session.removeAttribute("searchrelaycode");
                }
            }
            if (buttonValue != null && buttonValue.equals("add")) {
                if (session.getAttribute("relay") != null) {
                    session.removeAttribute("relay");
                }
                if (session.getAttribute("relaycode") != null) {
                    session.removeAttribute("relaycode");
                }
                if (request.getAttribute("rcode") != null) {
                    request.removeAttribute("rcode");
                }
                if (session.getAttribute("originList") != null) {
                    session.removeAttribute("originList");
                }
                if (session.getAttribute("destinationList") != null) {
                    session.removeAttribute("destinationList");
                }
                if (session.getAttribute("exception") != null) {
                    session.removeAttribute("exception");
                }
                if (session.getAttribute("portRelayList") != null) {
                    session.removeAttribute("portRelayList");
                }
                if (session.getAttribute("portobj1") != null) {
                    session.removeAttribute("portobj1");
                }
                if (session.getAttribute("portobj2") != null) {
                    session.removeAttribute("portobj2");
                }
                forwardName = "addRelay";
            }
        }
        request.setAttribute("buttonValue", buttonValue);
        return mapping.findForward(forwardName);
    }
}